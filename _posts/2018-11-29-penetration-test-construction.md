---
title: 渗透测试建设
description: 持续更新我的企业安全渗透测试建设经验
categories:
 - gitcheck
tags:
 - 渗透测试
 - 安全建设
---

2018-11-29 v0.1：工作一年零4个月，银行安全工程师，负责内外网Web渗透测试以及安全工具开发，安全部60人，渗透和扫描器开发团队由2人到4人，安全管理、移动终端、内网渗透、网络运维构架等只知道些概念，自己没有上手过，不懂细节，不作涉及，这里主要写一些我做过的能care到的部分

初到一个公司如何进行渗透测试建设（个人经验理解版）

* 除非自己是领导，不然做的事情要领导支持，看支持到什么程度做什么事情，我试过不给测试环境和测试账号要你走通全流程不能出漏洞，也有线上业务不能扫描扫挂了谁赔啊
* 做每一项之前自己要有个每一期的轮廓，能否做、怎么做、达成什么样的目标、还会有什么不足，这些都要具体，不是一句话需求，确定了做了除非不可抗力做好之前不要停，一鼓作气，再而衰，三而竭，成型了再说迭代
* 数据为重，业务优先，明确责任，是谁负责，最好不用风险不大、一般这种词语，个人感觉很不好（我现在领导经常这样说，不太好追问，好像说明了，但是我听不明确，就很烦，但也不能说不对，有的判断全靠经验直觉，也不能完全确定）

### 一期
#### 建设攻防平台
搭建内容（可以根据要检查的点和公司实际使用到的应用和服务情况不断补充）

* OS: Linxu、Windows
* 服务中间件：Nginx、Apache、Redis、RabbitMQ、SSH、MySQL等
* 靶机：WebGoat、DVWA、sqli-labs和根据需要检查的漏洞自己搭建的应用
* 工具：
    * 服务扫描：masscan、nmap
    * 主机扫描：Nessus、Nexpose、msf
    * Web扫描：AWVS或者其他
    * 代理接口扫描：Burp Suite、AppSpider
    * 其他：Kali、metasploit、自研工具等
* 漏洞知识库

作用：

私有网络的漏洞攻防平台，多人用，用于帮助开发了解漏洞和安全新人培养，也做漏洞复现和扫描器开发、规则改进的测试环境

漏洞知识库用于开发了解漏洞和了解修复方式，可在内网工单系统和攻防平台的环境中各同步一份，前期可以用OWASP渗透测试指南代替，可以慢慢新增自己的，确保正确详细，不是博客上抄来抄去的

#### 蜜罐、DNSlog
此块未自己上手做过，暂不涉及

作用：

用于内网盲打，用户黑盒检测时外网盲打内网等一些漏洞，目标为蜜罐和通过DNSlog等结果，提高检测准确率

蜜罐等原本作用没有实际操作过，暂不涉及

#### 资产梳理
IP、Domain、主机、网络设备、数据库、应用程序，根据网络情况进行梳理，内外网，不同域要分类梳理，也要对资产进行优先级分类

资产获取根据情况最好变成变动有接口推送的形式，方便渗透和运营的扫描器获取最新数据

#### 字典制作
方式：

制作字典的信息来源包括和做法包括:

作用：

暴力破解用的字典和敏感信息检查用和url管理台暴破的字典，并将字典作为接口提供，方便维护更改其他扫描器获取最新字典

#### 漏洞闭环
方式：

领导重视支持

看企业已有的工单系统，最好能将安全漏洞直接作为Bug单放到开发他们自己的工单系统中

在我的工作历程中，一般漏洞工单的上报、编辑、转交、结单、延期、挂起、退回等功能都需要

最好有能针对部门或项目出现漏洞情况（按漏洞类型打分，比如SQL注入记10分，简单的越权记10分，逻辑复杂难以避免的越权记1分，少见的漏洞记1分，分数越高指标越差），漏洞逾期未修复和退回次数的进行统计，按指标有一定的奖励和惩罚措施，避免无视安全工单和修复后不自测的情况不断消耗人力提醒和验证

结合攻防平台到漏洞知识库，漏洞修复方式要总结，一般来说开发、运维不懂安全或者懂一点点，安全懂一点点开发运维，跟不懂一样，开发运维为了稳定性，比如一处弱口令要修改多处系统，补丁打上了和现有版本不兼容等等其实会有很多问题，多总结，和开发运维达成一套有共识的修复方式，不是简单提交工单叫修复就可以

作用：漏洞闭环

#### 主机黑盒检查
方式：

* 基本信息检查：拉去资产列表，nmap扫描获取机器开放端口信息，获取的信息分类待用
* 系统版本、开放端口组件漏洞检查：Nessus、Nexpose，CVE有十几万，主机侧等检测靠商业扫描器应该是比较好的，Web一些框架兴许自研的更准确，没钱可以试用版先扫描一遍，自研还是维护成本高（维护人员能力和跳槽等不确定因素，而且我感觉大家漏洞预警全靠朋友圈。。。）
* 授权弱口令检查：用之前获取的字典，自写脚本，Medusa暴破
* 检查点:
* 检查后总结漏洞，更新原始镜像系统（主机镜像、Docker镜像），使新增机器默认安全

作用：发掘主机的安全漏洞，提出漏洞修补建议

#### 应用黑盒渗透测试
方式：

根据梳理出来的资产优先级进行分批渗透，一般外网大于内网，公开的大于与合作方的服务，用户入口要把握好

检查点：

* 维护渗透测试检查列表
* 常见漏洞
* Web框架CVE
* WAF和HIDS部署情况检查：曾检查出生产主机WAF未部署或者规则插件未安装，HIDS有的规则不告警的情况

作用：发掘应用的安全漏洞，提出漏洞修补建议

### 二期
#### 源代码安全扫描
方式：

* XXE等漏洞可以代码匹配字段检测，能比较准，一些这种漏洞等检测规则，如果要敏感信息扫描也在这里做
* OWASP的Dependency-Check依赖库版本检查
* 有钱Fortify扫一下，漏报问题优化一下，减少规则之类的

作用：可以检测一些代码风险

#### 上线/变更管理
上线需要经过工单，工具打通，运维管理，资产需要增加到例行化的扫描器中，代码经过扫描，业务不多需要经过渗透测试，多的话按优先级（或者1.0,1.5这种版本），有领导支持的话让测试UAT阶段自己走流程通过代理扫描器（我用Golang写Proxy+RabbitMQ+Burp Suite部署过代理扫描器，流量可去重后搜集做定期扫描，有其他更好收集手段就算了）扫接口，可以让渗透人员把精力用到逻辑漏洞等的检查上

#### 扫描器例行化运营
上面的主机和应用黑盒检查为第一次检查，之后都要根据当时使用的扫描器和检测方式能例行化的例行化，不能的进行周期人工检查

扫描器例行化，建立一个管理台（有精力页面，无精力命令行一样的）分发扫描任务（我使用Flask+Celery+RabbitMQ开发过扫描任务管理平台），根据实际情况按每日每周等一些间隔例行化扫描，每次扫描结束邮件通知，专人负责查看

周期人工检查和类似周期渗透测试了，保证每个周期检查到一遍就行

有上线/变更管理的权限后，可以将所有渗透测试作为运营任务人工检查的一部分

此时，将所有的扫描器、人工定时任务和版本变更/上线检查都作为安全运营的一部分进行下去，使安全运营包含

运营是一件繁琐的活，每天扫描报告一定要看，周期人工检查要认真做，漏洞工单要认真查证，检查点根据能收获的案例一点点加，都只能硬着头皮做下去

#### 安全预警和应急保障
* 漏洞获悉：情报源保证（反正我觉得靠朋友圈不好，不过我认识的少），乙方和大公司可能好些，听说一些机器硬件买的多还有py交易，提前通知
* 评估要点：漏洞原因、危害、响应范围、PoC、修复方案，评估效率和准确性靠人才
* 发现方式：agent采集进程配置，外部扫描器PoC扫，源码扫，人工排查，知会业务自查，SRC败金
* 漏洞修复：按工单系统流程走
* 发现和修复期间遭到攻击（未上手，不做涉及）
* 复盘总结：举一反三，比如微信0元支付漏洞，反馈XXE检测方式和可以扫代码检测出的漏洞，整理时间线输出文档，检测方式增加到运营周期扫描中

### 三期
#### 安全评估与加固
主机及应用安全基线

主机操作系统、网络设备、数据库、应用程序的安全检查发掘安全缺陷和错误配置

自己没有上手过，暂不涉及

#### 重点项目代码审计
上手不多，暂不涉及

#### SDL建设
看领导支持，最好简化流程，每一步提供的工具和方式自己先打磨一下，从试点开始外推，如果开发本来有良好流程肯定融入较快，上船了以后迭代（目前公司提了1年多SDL只做了一点点，不敢让业务干事情）

### 四期
#### HIDS
自己没有上手，暂不涉及

#### WAF
关系好的同事在开发有一点了解，详细没有上手过，了解比较空洞，不详细，不敢说

nginx插件分出流量，WAF作为分类器先保证一段时间未出判断结果则流量通过

根据github上找到的payload的规则提炼几条大正则（每条覆盖一部分小的规则），命中则进一步用小正则判断，正则根据写法和性能需求每条选择DFA和NFA引擎优化

WAF先在测试环境空跑，优化漏报误报率，再在测试环境正式跑，再优化，再在生产环境空跑，再优化，生产环境上线，再迭代优化

已知同事至少写了60条以上正则，每条至少一两百个字符，没有注释，有时候他自己也看不懂，且他单人维护，离职应该没人看得懂，WAF就完蛋，可以以此要挟年年拿S

感觉还是用商业好一些，有人稳定维护，如果实在有需求要自己加规则，可以少量规则做个并行WAF，或者可以自增规则的商业WAF？没有上手，不作评判了

#### SRC
我感觉是娱乐圈，但是找个渠道找人帮忙找漏洞还是好的，小公司没精力搞生态，以下听的大公司经验：

众测，高风险的给8000到10000元，投入多给平台白帽子，有活动，拉新，每年某段时间积分翻倍，漏洞少了就涨涨价，对招聘也有作用，出去开开会吹吹水拉了注册账号就算是有效果