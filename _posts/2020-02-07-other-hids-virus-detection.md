---
title: 天眼云镜对恶意文件的检测机制黑盒分析
description: 天眼云镜对脏牛EXP告警引起对测试分析，老板的问题都是大需求，不懂强行会也要会
categories:
 - 其他
tags:
 - 其他
---

### 0x00 背景
有一天一个同事正在做测试，下载了一个[dirtycow的EXP](https://github.com/Brucetg/DirtyCow-EXP)，放在测试环境的主机里

后来呢，大晚上，这台主机告警了，检测的分类竟然是后门，目录是那个同事的目录

其实如果我是运维的话肯定看到告警，肯定是先找这个同事问一下，大家都认识，又是我们的测试主机测试，文件夹名还是同事名字，是不是在做dirtycow的测试，我们的运维就不一样了，他要发到大群里给问，还要问这个文件是不是木马

那大boss就看到了呗，看到了就要问呗，腾讯云镜为啥判断为木马文件嘞

大家没人回话，我就随口回一句这个是公开的dirtycow的EXP，所以能检测为恶意文件，也不知道老板到底知不知道dirtycow是什么意思，反正以前他经常说多久以前脏牛漏洞的时候怎么怎么应急好像很牛逼的样子

反正老板最后发话，明天你们研究一下

这个研究一下就有点魔性了，研究啥，老板想知道什么，我最讨厌这种问题了，老板也不知道想知道什么，我们也不知道老板想知道什么，小组长级别的也不敢问，我这种底层员工就更不敢了，问的专业点怕老板看不懂让老板没面子了，不专业又好像我笨，听不懂老板话，跟宫廷剧陪皇帝一样，伴君如伴虎不是瞎说的

有个同事就牛逼，就说是MD5匹配，用的可能是哈勃木马黑库，说的我一愣一愣的，牛逼啊，我同事，哈勃木马黑库这个高级的东西都知道，搜一下好像是腾讯的，不愧是腾讯的同事

后来老板一句话没回，显然不满意，不然按我们老板的习惯会点个赞的

那没办法，运维平时天眼云镜检测的漏洞都是我来分析有没有危害的，上面我也发了句话，就让我来研究喽

真是死马当活马医，我是做渗透和扫描器的，也没病毒木马分析经验，招了这么多腾讯各类专家不就是干这种分析的事情吗，上面这个同事连哈勃木马黑库都知道，他研究不香吗

那么问题来了，到底研究啥

### 0x01 先找卖家
运维马上把我拉进了腾讯云云镜的卖家群，群里都是销售，看了聊天记录就是运维小组长一直问这个告警的文件到底有没有危害

我不是说了是公开的编译好dirtycow的EXP了吗，他们不是都知道dirtycow，以前我给他们解释漏洞的时候不是都解释过吗，怎么还问有没有危害

卖家销售也不知道呗，就要运维提供样本，给技术人员分析

我也看不下去，研究肯定不是研究这个有没有危害呗，网上搜索了一下木马检测原理，看了看，就问了销售几个问题

* 项目名字路径的普通二进制文件是否会告警（看是不是名称匹配，会不会误报）
* 是md5匹配吗，那不同版本的操作系统和gcc编译的dirtycow都能告警吗（看md5库样本够不够）
* 修改源码比如改掉print的内容后编译一样有提权功能的dirtycow会不会告警（有没有动态检测）
* dirtycow的源码未编译会不会告警（看是不是有源码正则匹配扫描）
* 全盘检测还是固定目录的检测
* 实时检测还是每日定时

反正销售带着这个问题回去问技术问一天，得出结论

* 这个是有害文件（回答运维的问题，没告警错可把运维高兴坏了。。。）
* 定时检测，每日凌晨（为啥之前23点告警？？？，23点是凌晨？？？）
* 全盘扫描
* 有md5匹配
* 有沙箱动态检测，但是是在腾讯后台不是在客户端上
* 和什么编译无关，要看这个程序是不是病毒木马，如果还有病毒木马代码，就应该会报警，但是编译之后也有可能检测不出，这几个问题无法回答

再问能不能详细一点，别问，问就商业机密，确定是问题，又找了网上公开的病毒检测结果证明是有问题的文件

感觉腾讯云技术也垃圾啊，看这名字这个GitHub的项目名路径地址都有还不知道是dirtycow，回答一下沙箱动态检测检测dirtycow行不行，对自己作品有没有点信心，还无法回答这几个问题，也有可能检测不出

### 0x02 黑盒测试
还是得自己动手丰衣足食

我觉得我上面问的问题都没有问题，搞清楚就可以了

所以我想办法搞了8个测试case

原来告警的这个编译好的EXP的编译前代码是[GitHub上的这个项目](https://github.com/dirtycow/dirtycow.github.io.git)，代码的注释里还写了编译方式

```
$ gcc -pthread dirtyc0w.c -o dirtyc0w
```

我做了8个样本

1. ubuntu18.04编译原有代码（测试ubuntu发行版编译的EXP是否能被检测）
2. ubuntu18.04编译的改写的代码（改写后绝对无法通过md5检测，只能被沙箱动态运行检测）
3. ubuntu18.04编译的hello world代码（测试文件名等是否会造成误报）
4. centos7.6编译原有代码（测试centos发行版编译的EXP能否被检测）
5. contos7.6编译的改写的代码（改写后绝对无法通过md5检测，只能被沙箱动态运行检测）
6. 原有的导致告警的EXP（对照组，用ubuntu低版本编译的EXP）
7. 原有C语言EXP代码（测试未编译的代码是否会被检测）
8. 改写后的C语言EXP代码（测试未编译的改写代码是否会被检测）

我还找了个对照组，[virustotal](https://www.virustotal.com/)

测试结果如下

```
+--------------------------+----------------------------+----------------------------+
| case                     | virustotal                 | 腾讯云镜                    |
+--------------------------+----------------------------+----------------------------+
| ubuntu编译的EXP           | 15/59个引擎成功检测出        | 检测出                      |
+--------------------------+----------------------------+----------------------------+
| ubuntu编译的EXP（改）      | 6/59个引擎成功检测出         | 检测出                      |
+--------------------------+----------------------------+----------------------------+
| ubuntu编译的hello world   | 59/59个引擎检测为正常文件     | 检测为正常文件               |
+--------------------------+----------------------------+----------------------------+
| centos编译的EXP           | 16/59个引擎成功检测出        | 检测出                      |
+--------------------------+----------------------------+----------------------------+
| centos编译的EXP（改）      | 8/59个引擎成功检测出         | 检测出                      |
+--------------------------+----------------------------+----------------------------+
| 原来告警的EXP              | 35/59个引擎成功检测出        | 检测出                      |
+--------------------------+----------------------------+----------------------------+
| 原有C语言的EXP代码文件      | 59/59个引擎检测为正常文件    | 检测为正常文件               |
+--------------------------+----------------------------+----------------------------+
| 原有C语言的EXP代码文件（改） | 59/59个引擎检测为正常文件    | 检测为正常文件               |
+--------------------------+----------------------------+----------------------------+
```

结果就是云镜的这个检测引擎还是有点牛逼啊，所有样本都检测出来了，跟virustotal的59个引擎比起来，至少可以排前6，算顶尖了

### 0x03 一些花絮
前面销售说到是每天凌晨扫描，我们第一次告警时间是晚上23点，不太对得上

我第一天下午把8个样本上传了3台测试机器，按理应该测试出15个问题，实际上到第二天早上9点半上班一个告警都没有

让销售又手工启动了一边才有，结果只检测到8个问题，问原因

* 腾讯云镜一台机器基础版本只能告警5次，我的机器被我搞太多次了，webshell等告警早超过5次了，这里少了5个问题
* 还有两台机器没有检测出之前被检测出的GitHub上编译好的EXP，也就是case6说是文件太多了可能没检测出来，在等几天就又了。。。

真的神奇，同一个EXP，这台机器上检测的出来，那台检测不出来

而且在virustotal上检测时，case6被最多引擎检测出来，而且检测比case1，2，4，5都要快，按理不会因为检测超时被跳过，真的神奇

按检测出的时间看，case1和case4确实检测速度快，case2和case5等了很久才检测出来，应该确实如销售所说动态检测会上传到腾讯后台

virustotal上的检测引擎之一有Tencent，而且它检测出来后的匹配的规则是

* case1，case4，case6是`Linux.Exploit.Cve-2016-5195`
* case2，case5是`Linux.Exploit.Dirtycow`

感觉这个刚好是md5和动态检测的区分点

### 0x04 结论与汇报
先说结论

* 按之前webshell告警，有正则匹配检查
* 二进制文件有md5检测，部分会上传到腾讯云后台沙箱动态检测
* 和virustotal的检测引擎比至少是前6名，算顶尖引擎

有一些不足

* 基础版单机只能检测5个恶意文件，超过后不检测
* 基础版扫描时间和效果不是很稳定，看告警时间不是每天固定，且存在同一个文件，有时检测出来有时检测不出来
* 因为非实时，编译、执行在删除不会检测出
* 提权检测通过检查进程用户从普通变成root，dirtycow通过修改未授权文件的方式无法检测出提权行为

然后把上面的测试过程和结论告诉boss，因为在武汉肺炎疫情期间，所以在家远程办公，就企业微信跟老板发了下消息

老板没回话，没点赞，也不知道他是没看懂呢还是我研究的问题不是他想我研究的问题

当手下真难，那么问题来了，老板到底要知道什么问题呢
