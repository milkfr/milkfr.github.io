---
title: 端口扫描建设
description: 端口扫描的设计与建设
categories:
 - 端口扫描
tags:
 - nmap
 - 端口扫描
 - 渗透工具 
---

### 端口扫描方式
1. 外部扫描，用nmap、masscan等从外部对端口进行探测分析
    * 优点：方便编写部署，成本低效果好
    * 缺点：接近100%准确，不一定100%，当本身主机有部署防止端口扫描的WAF需要开放白名单
2. 主机agent对进程端口占用情况进行分析
    * 优点：除非主机被入侵，被修改了进程端口查看的程序，不然100%准确
    * 缺点：agent开发成本和实时分析成本，公司本身有安全agent则没有问题
3. 流量镜像进行分析
    * 优点：准确
    * 缺点：成本高，流量镜像的存储分析成本较高


### 外网端口扫描建设
网上看过美团、Freebuf中的一些方案，一般是masscan+nmap的方式，masscan探测开放端口，nmap识别指纹

实际测试中效果不像网上说那么好，masscan速率提高接近带宽容易丢包，准确率下降很多，降低速率则速度就不比nmap快了，准确率还是比不上nmap，当然与网络环境也有较大的关系，可能一些大公司用于扫描的网络环境更好，不容易因为丢包问题漏

同时比如美团在官方技术博客中提到他们使用nmap扫描一次要两周时间，我使用1M带宽的云主机，完全利用了0.6M左右的带宽扫描两千多台外网主机所有1-65535的端口最多只要20几个小时，可能体会不到他们的速度不足的问题

个人经过对比测试，倾向的方式是直接使用nmap进行扫描，体量大就分布式部署，或者使用nmap的SYN扫描+nmap指纹识别的方式提高速度（实际上SYN扫描的速度是很奇怪的，感觉nmap内部调度对SYN扫描没有全连接扫描带宽利用率高）

具体的一些操作是：
* 让单机部署的nmap程序利用好带宽（实际测试中一些扫描方式带宽利用率很低，所以扫不出问题来），nmap命令扫描选项需要根据具体带宽、机器配置进行调优
* 使用分布式扫描，让单机的nmap扫描效果达到可接受的周期值，比如期望每隔半小时扫描全IP全端口一次，则单机对扫描范围在半小时内扫完
* 告警规则调优

个人参数调优的一些心得
1. 官网有关于性能调优的一些说明，需要先看，然后文档并不能让人很明白，需要实际操作扫描得到效果
2. 扫描时使用多开进程的方式为每个IP分配一个扫描进程，记录扫描时间，根据每个IP的特点和扫描时间可以发现一些问题
3. `--min-hostgroup`和`--min-parallelism`增大可以对带宽使用增加立竿见影，但扫描接近结尾时也可能因为分配问题导致速度很慢，可能还不如普通模式，要注意调试
4. `--host-timeout`未必需要设置很大（官网1800s），有些IP的端口全部关闭不返回信息的时候连接会一直持续，导致带宽利用率下降，比如平常一个IP可以在500s内扫描，这个值就设置600s，稍大于有返回的IP的扫描时间即可，减少时间消耗
5. 不同的扫描方式对带宽对占用完全不一样，选择使用多开进程的方式还是调整速率相关的参数
6. 调整到可接受的范围即可
7. 有能力看源码实现，我没有能力就算了

Python编写调用nmap的脚本的心得
1. nmap的调用不使用python-nmap和python-libnmap等库，对扫描结果的解析可以使用
2. 剥离出进程数量、一次调用扫描的IP数量和nmap的options，方便调试和根据机器带宽、配置等进行调优
3. 拉取IP和保存结果的方式最好使用API，避免资产变动造成遗漏，告警规则等交给分析服务器类似es stack去做
4. demo程序例如[Demo程序](https://github.com/milkfr/probe)
