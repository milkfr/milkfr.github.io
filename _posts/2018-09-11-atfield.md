---
title: ATField
description: 用Flask开发与部署外网渗透管理平台
categories:
 - 扫描器
tags:
- Flask
- 技术栈
- Python Web
---

### 0x00 概述
[项目地址](https://github.com/milkfr/ATField)

Web项目，用于外网探测和自动化扫描定时任务的管理台，以小时候看新世界天鹰战士的ATField命名

![1](https://milkfr.github.io/assets/images/posts/2018-09-11-atfield/1.png)

包含外网域名解析结果、IP对应开放端口探测结果、代理收集的Web CGI汇总，以及分发各种扫描工具的定时扫描任务，产出日报、周报、月报

使用Python Flask开发，MySQL作为数据库，ubuntu+nginx+supervisor+gevent+gunicorn进行部署，之后会改用Docker

本文简单介绍一下开发过程以及部署和遇到的问题


### 0x01 开发过程
考虑到一般安全部不会太大，这种管理台供内部使用，性能等都不是很重要，快速开发部署稳定运行就行，就使用Flask框架，前端无需学习，使用Bootstrap和Jinja2，一些功能上也无需完善，用户注册等直接在数据库内添加，做好RBAC模型等权限控制，前端无需隐藏等等

开发参考《Flask Web开发：基于Python的Web应用开发实战》，代码参考随书对应的GitHub项目[flasky](https://github.com/miguelgrinberg/flasky)，实际上书过一遍，参考好大型项目一章，之后看代码比较好

实际开发中数据库设计与方法实现最为重要，一般增改删等操作必须使用数据库ORM类提供等方法，避免直接操作导致问题，查询因为用户少接口少且自己就是做安全的，不怕出现越权等问题，不限制，接口逻辑去查询，实际开发上小团队使用也不一定会出现水平越权的逻辑

开发上除了类似RBAC这种基础模块设计要好，数据库表设计，整个项目的整体框架和文件分布对应的功能也要设计全面，本人不具有设计模式的知识，但设计时注意维护和拓展，多思考一些是没有错的，此外，功能上不必要很完善，小团队使用简单就好，低频操作完全可以不自动化

### 0x02 测试过程
还没有自动化和性能测试，目前来说不必要，之后看有没有需求补上

### 0x03 部署过程
暂时不使用Docker部署

使用Python Flask开发，MySQL作为数据库，ubuntu+nginx+supervisor+gevent+gunicorn进行部署

不同等软件版本可能导致不同问题，这里不细致区分，只有个大概过程

#### MySQL
```
# shell
# 安装
$ sudo apt install mysql-server mysql-client

# 创建数据库
$ mysql -u root -p  # 登录mysql
mysql> create database atfield  # 创建表
mysql> exit  # 退出mysql

# 修改MySQL编码为UTF-8
~$ sudo vim /etc/mysql/conf.d/utf8_charset.cnf

# /etc/mysql/conf.d/utf8_charset.cnf
[mysqld]
character-set-server=utf8
[client]
default-character-set=utf8

# shell
~$ sudo service mysql restart
~$ mysql -u root -p
mysql> show variables like "%character%"
+--------------------------+----------------------------+
| Variable_name            | Value                      |
+--------------------------+----------------------------+
| character_set_client     | utf8                       |
| character_set_connection | utf8                       |
| character_set_database   | utf8                       |
| character_set_filesystem | binary                     |
| character_set_results    | utf8                       |
| character_set_server     | utf8                       |
| character_set_system     | utf8                       |
| character_sets_dir       | /usr/share/mysql/charsets/ |
+--------------------------+----------------------------+ 
```

#### Flask APP
```
$ git clone https://github.com/milkfr/ATField.git
$ cd ATField
$ vim .flaskenv  # 修改配置变量为生产环境，连接数据库的URI等信息
$ mkdir certs
$ cp /path/ca.* certs/  # 复制SSL证书信息到certs目录下
$ sudo apt install python3
$ sudo apt install python3-pip
$ pip3 install virtualenv
$ virtualenv --no-site-packages venv
$ source venv/bin/activate
$ pip install -r requestments/common.txt
$ flask deploy  # 第一次部署时使用，初始化数据库，如果有域名、IP等信息可以放到ip.txt和domain.txt中
$ flask run  # 运行排错
```

#### gunicorn+gevent
```
$ pip install gunicorn gevent
$ gunicorn wsgi:app -b 127.0.0.1:8080 -w 3 -k gevent --timeout 600 --access-logfile /tmp/gunicorn.access-MYDOMAIN.log --error-logfile /tmp/gunicorn.error-MYDOMAIN.log  # 查看效果
```

gunicorn和gevent的各项参数配置可以根据需要改，这里只要能用就行，毕竟也不是很了解它们

#### supervisor
```
# shell
$ sudo apt install supervisor  # 因为没有支持python3的版本，所以使用apt安装
$ sudo vim /etc/supervisor/conf.d/atfield.conf

# /etc/supervisor/conf.d/atfield.conf
[program:ATField]
command = /home/ubuntu/ATField/venv/bin/gunicorn wsgi:app -b 127.0.0.1:8080 -w 3 -k gevent --timeout 600 --access-logfile /tmp/gunicorn.access-MYDOMAIN.log --error-logfile /tmp/gunicorn.error-MYDOMAIN.log
directory = /home/ubuntu/ATField/
user = ubuntu
autostart = true
autorestart = true
redirect_stderr = true

# shell
$ sudo supervisorctl reread
$ sudo supervisorctl update
$ sudo supervisorctl start  ATField
$ sudo supervisorctl status  # 查看效果
$ ps aux | grep gunicorn  # 查看效果
```

#### nginx
```
# shell
$ sudo apt install nginx
$ sudo vim /etc/nginx/sites-available/default

# /etc/nginx/sites-available/default
server {
    listen 80;
    server_name domainname;
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443;
    server_name domainname;

    # ssl
    ssl on;
    ssl_session_timeout 5m;
    ssl_certificate /home/ubuntu/ATField/certs/ca.cer;
    ssl_certificate_key /home/ubuntu/ATField/certs/ca.key;

    location /static {
        alias /home/ubuntu/ATField/app/static;
    }

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;  # fix bug about flask redirect from https to http
    }
}

# shell
sudo service nginx restart
```

之后通过访问域名即可

#### Docker
之后可能会改用Docker部署

### 0x04 遇到的问题
开发遇到的问题不大，基本上是抉择，该用什么方案，这个功能要不要
部署上遇到的问题较多，比如supervisor启动gunicorn报Exited too quickly的问题占用的很长解决时间，问题与环境有关，还有部署HTTPS时Flask的redirect会将HTTPS会返回HTTP的解决也找了蛮久，记录一下，其他都一般小问题
