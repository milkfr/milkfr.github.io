---
title: 2019年总结与反思——漏洞观与开发
description: 2019年，总结与反思
categories:
 - 总结与反思
tags:
 - 总结与反思
---

### 0x00 2019总览
这一年，主要是课外学习了一下Java安全方面的一些知识，工作上还是扫描器、渗透和SDL

这一年进步相对之前还是大一些的

今年有4次从外网发现了公司正式业务里非逻辑以外的高风险漏洞，两个无需授权的SSRF、一个未授权代理和一个fastjson的RCE，之前两年不管全年众测的SRC还是自己发现只有一次需要授权的XXE、一次要授权的SQL注入和一次测试端口开放用的Struts2的RCE

今年一年超过历史全部，也算是很棒了的

通过对Java安全的学习，比起通用的Web漏洞，也算是对漏洞观进行了一次刷新，因为学习过程也必须会至少写Demo，能开发，SDL过程中和开发的交流让我对开发和安全关系也有了更深入的理解

总得来说，这一年收获还可以，好像自己变强大一点了

### 0x01 漏洞观
#### 数据流转
首先今年对我影响最大的是这本书[《Struts2技术内幕——深入解析Struts2架构设计与实现原理》](https://book.douban.com/subject/7154446/)

更深入一点是里面的一个词，叫做数据流转

这本书虽然不是讲安全的，但是里面数据流转这个词确实是触动了我这个学安全的

如果网络或者文件中的数据是以二进制或者文本这种类型存在的，我们将之称之为弱类型，而类似Java这种语言，包括它语言本身的数据结构，和通用库、三方库开发人员自定的Bean等数据结构，是强类型的，应用、网络之间信息交流，就是不断让编程语言的强类型数据和网络、文件这些弱类型数据进行交互和处理的过程，这个交换过程，就是数据流转

这也是为什么我们做安全强调输入输出一样，程序就是数据结构和算法，数据流转就是重中之重，数据流转中的信任排查不足，也是漏洞的来源地

SQL注入是因为应用程序和数据库之间的数据流转，编程语言的String弱类型转换成SQL语言的强类型导致的

反射型XSS是因为HTTP包的二进制或者说String的弱类型转换成HTML和JS的强类型导致的

结合以上，基本所有注入都是数据流转的问题

然后反序列化漏洞也是，二进制的序列化数据转换为Java、PHP、Python中的数据结构的时候，也是弱类型转换成强类型的数据流转造成的漏洞

所以Struts2才有很多OGNL的RCE漏洞，而Spring组件也有很多SpEL表达式的漏洞，因为本身HTTP协议到Java世界只有一次弱类型到强类型的转换，增加OGNL和SpEL就相当于多了一层编程语言，原来的一次数据流转，变成了两次数据流转，所以才多发漏洞，算这些漏洞的本质，其实都和SQL注入一样也是注入，是在框架页面模版或者参数中注入表达式，但是表达式语言和编程语言本身结合太紧密了，不像SQL注入一样界限明显而已

以前按照[《白帽子讲Web安全》](https://book.douban.com/subject/10546925/)里，我们把安全问题归结为信任问题，这个观点感觉很不错，信任边界就是安全边界，而存在数据流转就可以说存在安全边界，也就是信任边界

这个边界没有对数据流转中的数据进行严格的校验，就造成了安全漏洞，基本上，我们的通用型漏洞都是这样原因，不管是以前的SQL注入、XSS，还是近年来新兴的XXE或者反序列化漏洞

而数据流转这个概念，比起信任这个词，范围更小，也更容易形容这一些通用漏洞

#### 逻辑
作为一个安全人员，我觉得我主要学习的是数据流转造成的漏洞，它和逻辑漏洞可以区分开，因为它是有迹可循的，是变化不大，是可以通过技术手段，比如WAF、HIDS、IAST、RASP等来在各个层次建立防御的

还有更大的一个分类是逻辑漏洞，比如未授权、水平垂直权限问题、钓鱼、协议的一些设计漏洞等，所以这里把逻辑和数据流转造成的漏洞区分开来，因为这些问题往往不能通过单纯的防御产品做到很好

#### 利用链
gadget chain是在学习反序列化漏洞时候对我影响比较大的一个词，以前学反序列化看Commons Collections总是半懂不懂，看完忘、忘完看，直到看到gadget，才知道原来看的不是漏洞，而是利用链

一个漏洞，如果没有利用链，哪怕是SQL注入可能也是个没什么卵用的垃圾洞，如果有完整的利用链，钓鱼都能钓出花儿来，这是以前我的观念里不能接受的，以前能RCE的就是好漏洞、能SQL注入就是好漏洞，XSS这些都是垃圾

慢慢的，比如公众号的安全预警，有时候一个很多年前的老漏洞，来了个新PoC都会预警一番，以前是不能接受的，现在明白了，新的利用链，就是个新漏洞

比如fastjson今年的曝出的漏洞，其实还是一个新绕过，但是这个新利用链，让我成功RCE一个正式业务的几台机器

眼光要放宽，有时候一个新利用链比一个听起来好像很牛逼评分很高的漏洞危害要大得多

#### 漏洞观总结
总的来说，今年对自己的漏洞观进行了升级，把漏洞类型分成了数据流转造成的漏洞和逻辑漏洞，然后理解了利用链的对漏洞危害性影响

### 0x02 开发
今年让我触动更大的是，是开发和安全的不可分割

#### 安全人员需要学开发
还在为反序列化漏洞的Commons Collections烦恼吗，还在为Struts2 OGNL造成的RCE的调试难过吗，那就学学Java开发

说起来今年大部分能理解的漏洞中原来让我不能理解的部分，其实是对Java和Java框架的不理解，然后是还有不理解，网上文章又含含糊糊的，实际上是debug过程中对部分设计模式的不理解

理解了就能理解漏洞

就像我大学的时候帮老师做过Web开发，所以学习Web通用漏洞的时候，像SQL注入、XSS很快也觉得很简单，如果有什么漏洞难到你了，就去学学相关知识的开发吧，磨刀不误砍柴工

然后还有一点，我一直诟病我自己公司安全部的也是我的导师这一级别的不懂得开发和构架，很多模块抽象设计都不懂，所以很多开发上面的事情也是重复在做，作好几遍，其实是构架上没有设计好，而做安全的大部分都是只会写些脚本，很多写个扫描器的意思就是写个脚本

相信随着时代发展，不懂开发和构架的安全人员也会慢慢跟不上甲方的节奏吧

第一批想到把WAF设置在网络中间、agent添加HIDS、流量和日志检测，在这些层次上添加安全防护的人，肯定是懂开发、懂构架的

所以不管是从需要理解漏洞还是从安全构架上安全人员也需要学习开发

#### 开发人员也可以辅助安全
在帮助开发部门建立SDL的过程中，发现有些部门的一些情况

有一个部门在我们两年给他们渗透测试的过程中，总结的漏洞的情况，自己的测试添加了一份自己的安全测试列表，这个列表和我们渗透测试组自己的渗透列表基本上80%都是重合的

有一个组自己将dependency-check加到了他们项目的maven构建和CI流程中

有一个前端组，写点击劫持的js防御代码是根据[斯坦福大学论文](http://seclab.stanford.edu/websec/framebusting/framebust.pdf)里的论文的写法，而不是从网上抄的

```
<style id="antiClickjack">
    body {display: none !important;}
</style>

<!-- 此段JS放在body加载完成后 -->
<script>
if (self == top) {
    var antiClickjack = document.getElementById("antiClickjack");
    antiClickjack.parentNode.removeChild(antiClickjack);
} else {
    top.location = self.location;
}
</script>
```

以上都是他们自主独立完成的，安全只提供了一些版本的渗透测试报告

其实，在现在越来越重视安全的现在，就算安全不帮助开发建设安全，开发也会自己想一些方法保障安全，他们其实需要的是安全告知漏洞类型和原理

他们本身就很能理解XSS、SQL注入这些漏洞，因为他们的开发知识很容易帮助他们理解，然后也会存在一些开发无法了解的漏洞，比如一些Java反序列化，因为他们的开发流程中可能也不会关注到这些gadget，对于这些他们因为自生开发水平问题，所以无法理解的漏洞，安全去进行一些帮助理解比较好

任由他们自己想办法，他们有更完善的开发流程处理，兴许他们能在开发流程和软件构架中找到更好的切入点和安全结合，把他们的办法中好的部分学习起来，我感觉是一种很聪明的办法，多和开发沟通学习，让他们辅助安全

### 0x03 总结
还是有进步的一年，希望能稳步保持