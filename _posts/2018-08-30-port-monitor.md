---
title: 端口监控建设
description: 端口监控的设计与建设
categories:
 - 扫描器
tags:
 - nmap
 - 端口扫描
 - 渗透工具 
---

### 端口监控方式
1. 外部扫描，用nmap、masscan等从外部对端口进行探测分析
    * 优点：方便编写部署，成本低效果好
    * 缺点：接近100%准确，不一定100%，当本身主机有部署防止端口扫描的WAF需要开放白名单
2. 主机agent对进程端口占用情况进行分析
    * 优点：除非主机被入侵，被修改了进程端口查看的程序，不然100%准确
    * 缺点：agent开发成本和实时分析成本，公司本身有安全agent则没有问题
3. 流量镜像进行分析
    * 优点：准确
    * 缺点：成本高，流量镜像的存储分析成本较高


### 外部端口扫描建设
网上看过美团、Freebuf中的一些方案，一般是masscan+nmap的方式，masscan探测开放端口，nmap识别指纹

实际测试中效果不像网上说那么好，masscan速率提高接近带宽容易丢包，准确率下降很多，降低速率则感觉速度不比nmap快多少了，准确率还是比不上nmap，当然与网络环境也有较大的关系，可能一些大公司用于扫描的网络环境更好，不容易因为丢包问题漏，我在带宽1M的自己买的腾讯云主机上测试扫描2000台主机所有端口效果不好

同时比如美团在官方技术博客中提到他们使用nmap扫描一次要两周时间，我使用1M带宽的云主机，完全利用了0.6M左右的带宽扫描两千多台外网主机所有1-65535的端口最多需要三天，可能体会不到他们的速度不足的问题，能分配带宽大一点机器的话1天1次肯定没问题

个人经过对比测试，倾向的方式在有机器成本够的情况下，直接使用nmap进行扫描，体量大就分布式部署，或者使用nmap的SYN扫描+nmap指纹识别的方式稍微提高速度

具体的一些操作是：
* 让单机部署的nmap程序利用好带宽等机器配置（实际测试中一些扫描方式带宽利用率很低，所以扫得慢，也存在内存不足导致中断，使整个扫描组失效），nmap命令扫描选项需要根据具体带宽、机器配置进行调优
* 使用分布式扫描，让单机的nmap扫描效果达到可接受的周期值，比如期望每隔半小时扫描全IP全端口一次，则单机对扫描范围在半小时内扫完
* 告警规则调优

个人参数调优的一些心得
1. 官网有关于性能调优的一些[说明](https://nmap.org/man/zh/man-performance.html)，需要先看，然后文档并不能让人很明白，需要实际操作扫描并且监控带宽变化学习调优
2. 并不建议通过多开进程或者线程的方式扫描，也不建议使用第三方库，除非你知道第三方库做了什么修改
3. 速率和扫描方式有很大的关系，每种扫描方式策略不一样，这里值用sT的全连接扫描说明
4. `--host-timeout`参数是最重要的调优参数，由于性能较差或不可靠的网络硬件或软件、带宽限制、严格的防火墙等原因，一些主机需要很长的时间扫描。这些极少数的主机扫描往往占据了大部分的扫描时间。如果扫描的一个组都是这种主机，容易造成带宽占不满的情况，一个扫描组其他主机扫描都扫描完成，剩下少数是这样的主机，也容易造成长时间等待，浪费带宽。所以调小这个参数到可接受范围非常重要，或者对反应快和慢对主机分开用不同策略扫描，推荐这种方式
5. `--min/max-hostgroup`参数，nmap将多个IP分组，开始扫描时组小，慢慢变大到一个较大值，对带宽有自信可以一开始就设置一个大的组，减少一开始带宽占不满的可能，一个组扫描结束才会进行下一个组，如果存在上面一条所说的主机，可能会出现长时间等待的情况，所以对于端口数较少的很多主机的扫描（一般外网扫描），一个组是所有要扫描的IP可能更好
6. `--min/max-rtt-timeout`和`--min/max-parallelism`参数，测试调整可以对带宽使用增加立竿见影，但扫描接近结尾时也可能因为类似timeout的问题导致速度很慢，要注意调试，可能会因为挑大漏结果，nmap本身其实有策略，这两个参数建议不调试
7. `--min/max-rate`参数，建议调整到带宽使用率较高的位置，不占满减少丢包也不太小导致利用率变大，测试sT（全连接）模式rate1500约为0.9M，会有浮动，不能控制准确，建议调整这个参数是不错的选择
8. 调整到可接受的范围即可，内存等机器配置不足是类似将扫描结果写入XML会失败
9. 有能力看源码实现，我没有能力就算了

![1](https://milkfr.github.io/assets/images/posts/2018-08-30-port-monitor/1.png)

如上图，一般扫描时，调整`--min-hostgroup`，某段时间带宽占用率高，一段时间带宽占用率低，一段时间低，占用低时的扫描组主机反应慢，连接全部占用但是无响应，导致占用低，同时，一个组扫描快扫描完和新一个组开始时有带宽下降的时间，注意观察带宽利用变化调试，建议还是按反应快慢对主机分组，对反应快的组调整`--min/max-hostgroup`，反应慢的组调整`--host-timeout`

Python编写调用nmap的脚本的心得
1. nmap的调用不使用python-nmap和python-libnmap等库，对扫描结果的解析可以使用，我调用时扫描效果和直接调用命令有时会不一致，原因没有去探究
2. 剥离出进程数量、一次调用扫描的IP数量和nmap的options，方便调试和根据机器带宽、配置等进行调优
3. 拉取IP和保存结果的方式最好使用API，避免资产变动造成遗漏，告警规则等交给分析服务器类似es stack去做
4. demo程序例如[Demo程序](https://github.com/milkfr/probe)
